<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heleninha Trainer - Gest√£o Profissional</title>
    <!-- Font Fredoka para t√≠tulos amig√°veis -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configura√ß√µes para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Heleninha PT">
    
    <style>
        /* Vari√°veis de Tema Conforme Protocolo UI */
        :root {
            --bg-body: #F0F4FF; 
            --bg-card: #FFFFFF; 
            --text-main: #1D2D6B; 
            --text-muted: #5C6B9A;
            --primary: #3D79FF; 
            --primary-hover: #2C5ED6;
            --accent: #FF8FB1; 
            --navy: #1D2D6B; 
            --border-color: #DDE5F5;
            --result-bg: #0A0F1E;
            --result-text: #3D79FF;
            --radius-card: 24px;
            --radius-input: 16px;
        }

        [data-theme='dark'] {
            --bg-body: #0A0F1E;
            --bg-card: #161C2D;
            --text-main: #F0F4FF;
            --text-muted: #8E9ABF;
            --border-color: #242D45;
            --result-bg: #000000;
        }

        [data-theme='violet'] {
            --bg-body: #F5F3FF;
            --bg-card: #FFFFFF;
            --text-main: #4C1D95;
            --primary: #7C3AED;
            --accent: #FF8FB1;
            --navy: #2E1065;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-in-out; -webkit-tap-highlight-color: transparent; }
        html { font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; }

        /* Estilos de Auth (Login/Cadastro) */
        #auth-screen { display: flex; flex-direction: column; justify-content: center; min-height: 80vh; }
        .auth-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius-card); border: 1px solid var(--border-color); box-shadow: 0 15px 30px rgba(29, 45, 107, 0.05); }
        .auth-toggle { display: flex; gap: 10px; margin-bottom: 25px; background: var(--bg-body); padding: 5px; border-radius: 12px; }
        .auth-toggle button { flex: 1; border: none; padding: 10px; border-radius: 10px; font-family: 'Fredoka', sans-serif; font-weight: 600; cursor: pointer; background: transparent; color: var(--text-muted); }
        .auth-toggle button.active { background: var(--primary); color: white; }
        .auth-footer { text-align: center; margin-top: 15px; font-size: 0.8rem; color: var(--text-muted); }

        /* Estilos do App principal */
        #app-screen { display: none; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { font-family: 'Fredoka', sans-serif; font-size: 1.4rem; margin: 0; font-weight: 700; letter-spacing: -0.02em; }

        .header-actions { display: flex; gap: 10px; }
        .action-btn { 
            border: none; 
            background: var(--primary); 
            color: white;
            width: 42px; height: 42px; 
            border-radius: 14px; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; 
            box-shadow: 0 4px 10px rgba(61, 121, 255, 0.2);
        }
        .action-btn:active { transform: scale(0.9); background-color: var(--accent); }

        .card { 
            background: var(--bg-card); 
            padding: 24px; 
            border-radius: var(--radius-card); 
            box-shadow: 0 15px 30px -5px rgba(29, 45, 107, 0.05); 
            border: 1px solid var(--border-color); 
            margin-bottom: 25px; 
        }

        .label { 
            display: block; 
            font-family: 'Fredoka', sans-serif;
            font-size: 0.8rem; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.08em; 
        }
        
        select, .input-styled { 
            width: 100%; padding: 14px; 
            border-radius: var(--radius-input); 
            border: 2px solid var(--border-color); 
            margin-bottom: 20px; 
            font-size: 1rem; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            outline: none; 
            font-weight: 600;
        }

        .year-stepper { 
            display: flex; align-items: center; justify-content: space-between; 
            background: var(--bg-body); 
            border-radius: var(--radius-input); 
            padding: 8px; margin-bottom: 20px; 
            border: 2px solid var(--border-color); 
        }
        .step-btn { 
            background: var(--primary); color: white; 
            border: none; width: 44px; height: 44px; 
            border-radius: 12px; font-size: 1.5rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .year-display { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--navy); }

        .session-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .session-box { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .date-label { font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; display: block; color: var(--text-muted); }
        
        .session-select {
            -webkit-appearance: none; appearance: none;
            width: 58px; height: 58px; border-radius: 50%; border: none;
            color: white; font-weight: 700; font-size: 1.4rem;
            text-align: center; text-align-last: center; 
            cursor: pointer; padding: 0;
            background-color: var(--primary); 
            box-shadow: 0 6px 12px rgba(61, 121, 255, 0.15);
            display: flex; align-items: center; justify-content: center;
            outline: none;
        }
        
        .bg-0 { background-color: #B0B9D1; opacity: 0.6; }
        .bg-1 { background-color: var(--primary); }
        .bg-2 { background-color: #2C5ED6; }
        .bg-3 { background-color: var(--navy); }

        .result-box { 
            background: var(--result-bg); color: #8E9ABF; 
            padding: 20px; border-radius: 20px; 
            font-family: 'Courier New', monospace; font-size: 0.95rem; 
            white-space: pre-wrap; margin-bottom: 10px; 
            min-height: 100px; border: 2px solid var(--primary); line-height: 1.5; 
        }
        
        .button-group { display: flex; gap: 10px; margin-bottom: 25px; }

        .copy-btn { 
            flex: 2;
            background-color: var(--navy); 
            color: white; 
            padding: 18px; 
            border: none; 
            border-radius: 18px; 
            font-family: 'Fredoka', sans-serif;
            font-weight: 600; font-size: 1rem; 
            cursor: pointer; 
            box-shadow: 0 8px 20px rgba(29, 45, 107, 0.2); 
            text-transform: uppercase;
        }

        .save-btn {
            flex: 1;
            background-color: var(--accent);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 18px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600; font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 143, 177, 0.2);
        }

        .copy-btn:active, .save-btn:active { transform: translateY(3px); box-shadow: none; }

        .history-section { margin-top: 30px; }
        .history-title { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: var(--navy); display: flex; justify-content: space-between; align-items: center; }
        .clear-history { font-size: 0.7rem; color: var(--accent); cursor: pointer; text-transform: uppercase; border: 1px solid var(--accent); padding: 4px 8px; border-radius: 8px; }
        
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { 
            background: var(--bg-card); 
            padding: 16px; 
            border-radius: 18px; 
            border-left: 5px solid var(--primary); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .history-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; }
        .history-date { font-size: 0.7rem; color: var(--text-muted); }
        .history-total { color: var(--primary); font-family: 'Fredoka', sans-serif; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 30, 0.6); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 32px; padding: 30px; border: 1px solid var(--border-color); overflow-y: auto; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--navy); }
        .close-modal { font-size: 2rem; cursor: pointer; background: none; border: none; color: var(--accent); font-weight: bold; }
        
        .price-input-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .price-input-row span { flex: 1.5; font-weight: 700; font-size: 0.9rem; color: var(--text-muted); }
        .price-input-row input { flex: 1; margin-bottom: 0; text-align: right; font-weight: 800; border-color: var(--border-color); color: var(--primary); }

        .supabase-status { font-size: 0.7rem; margin-top: 10px; display: block; text-align: center; font-weight: 600; }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }

        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 14px 28px; border-radius: 40px; font-family: 'Fredoka', sans-serif; font-size: 0.9rem; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; box-shadow: 0 8px 15px rgba(255, 143, 177, 0.3); }
        
        /* Loader */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Overlay de Carregamento -->
    <div id="loading-screen" class="loading-overlay">
        <div class="spinner"></div>
        <p style="font-family:'Fredoka', sans-serif; color:var(--navy)">Heleninha Trainer</p>
    </div>

    <!-- Tela de Login / Registo -->
    <div id="auth-screen" class="container" style="display: none;">
        <h1 style="text-align: center; margin-bottom: 25px;">üëã Bem-vinda(o)!</h1>
        <div class="auth-card">
            <div class="auth-toggle">
                <button id="btn-login-mode" class="active" onclick="setAuthMode('login')">Login</button>
                <button id="btn-register-mode" onclick="setAuthMode('register')">Registo</button>
            </div>

            <div id="login-fields">
                <span class="label">E-mail</span>
                <input type="email" id="auth-email" class="input-styled" placeholder="exemplo@email.com">
                <span class="label">Senha</span>
                <input type="password" id="auth-password" class="input-styled" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                
                <div id="register-only-fields" style="display: none;">
                    <span class="label">Confirmar Senha</span>
                    <input type="password" id="auth-confirm-password" class="input-styled" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <button id="auth-submit-btn" class="copy-btn" style="width: 100%;" onclick="handleAuthSubmit()">Entrar</button>
            </div>
            
            <p id="auth-info" class="auth-footer"></p>
        </div>
    </div>

    <!-- Tela Principal do Aplicativo -->
    <div id="app-screen" class="container">
        <header>
            <h1>üí™ HELENINHA TRAINER</h1>
            <div class="header-actions">
                <button class="action-btn" onclick="toggleSettings()" title="Ajustar Valores">‚öôÔ∏è</button>
                <button class="action-btn" onclick="cycleTheme()" id="theme-icon">‚òÄÔ∏è</button>
                <button class="action-btn" onclick="handleLogout()" title="Sair" style="background-color: var(--accent);">üö™</button>
            </div>
        </header>

        <div class="card">
            <span class="label">M√™s de Cobran√ßa</span>
            <select id="month-select" onchange="generateDates()"></select>

            <span class="label">Ano</span>
            <div class="year-stepper">
                <button class="step-btn" onclick="changeYear(-1)">‚àí</button>
                <span id="year-display" class="year-display">2025</span>
                <button class="step-btn" onclick="changeYear(1)">+</button>
            </div>

            <span class="label">Dia da Semana</span>
            <select id="day-select" onchange="generateDates()">
                <option value="1">Segunda-feira</option>
                <option value="2">Ter√ßa-feira</option>
                <option value="3">Quarta-feira</option>
                <option value="4">Quinta-feira</option>
                <option value="5">Sexta-feira</option>
                <option value="6">S√°bado</option>
                <option value="0">Domingo</option>
            </select>

            <span class="label">Participantes por Aula</span>
            <div id="session-container" class="session-grid"></div>
        </div>

        <div class="label">Resumo Gerado:</div>
        <div id="result-text" class="result-box"></div>
        
        <div class="button-group">
            <button class="copy-btn" onclick="copyToClipboard()">Copiar WhatsApp</button>
            <button class="save-btn" onclick="saveToHistory()" title="Salvar no Hist√≥rico">üíæ</button>
        </div>

        <div class="history-section">
            <div class="history-title">
                <span>Hist√≥rico Recente</span>
                <span class="clear-history" onclick="clearHistory()">Limpar</span>
            </div>
            <div id="history-list" class="history-list"></div>
        </div>

        <div id="toast" class="toast">‚úì A√ß√£o conclu√≠da!</div>
    </div>

    <!-- Modal de Configura√ß√µes -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Configura√ß√µes</span>
                <button class="close-modal" onclick="toggleSettings()">√ó</button>
            </div>
            
            <span class="label">Valores dos Pacotes</span>
            <div class="price-input-row">
                <span>Solo (1 Aluno):</span>
                <input type="number" id="price-1" class="input-styled" onchange="saveSettings()">
            </div>
            <div class="price-input-row">
                <span>Duo (2 Alunos):</span>
                <input type="number" id="price-2" class="input-styled" onchange="saveSettings()">
            </div>
            <div class="price-input-row">
                <span>Trio (3 Alunos):</span>
                <input type="number" id="price-3" class="input-styled" onchange="saveSettings()">
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">
            
            <span class="label">Sincroniza√ß√£o Cloud</span>
            <span id="supabase-status" class="supabase-status status-offline">‚óè Desconectado</span>

            <p style="font-size: 0.7rem; color: var(--text-muted); margin: 20px 0; text-align: center; font-style: italic;">
                As credenciais da nuvem est√£o configuradas internamente.
            </p>
            <button class="copy-btn" style="width:100%" onclick="toggleSettings()">CONCLU√çDO</button>
        </div>
    </div>

    <script>
        const MONTH_NAMES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const THEMES = ['light', 'dark', 'violet'];
        
        const DEFAULT_SUPABASE_URL = "https://xmbydwfxkbpcjmojtyvk.supabase.co";
        const DEFAULT_SUPABASE_KEY = "sb_publishable_9cmC_iJS5VL6j_W_CetgXw_k-pf5gii";

        let prices = { 1: 75, 2: 95, 3: 115 };
        let history = [];
        let currentSessions = [];
        let currentYear = new Date().getFullYear();
        let currentThemeIndex = 0;
        let currentTotal = 0;
        let supabaseClient = null;
        let currentAuthMode = 'login';

        window.onload = async () => {
            initSupabase(DEFAULT_SUPABASE_URL, DEFAULT_SUPABASE_KEY);
            
            // Verificar Sess√£o
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                showApp();
            } else {
                showAuth();
            }

            // Restaurar Configura√ß√µes de Pre√ßos
            const savedSettings = localStorage.getItem('heleninha_settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                prices = settings.prices || prices;
            }
            document.getElementById('price-1').value = prices[1];
            document.getElementById('price-2').value = prices[2];
            document.getElementById('price-3').value = prices[3];

            // Restaurar Hist√≥rico Local
            const savedHistory = localStorage.getItem('heleninha_history');
            if (savedHistory) {
                history = JSON.parse(savedHistory);
                renderHistory();
            }

            // Restaurar Tema
            const savedTheme = localStorage.getItem('heleninha_theme') || 'light';
            setTheme(savedTheme);
            currentThemeIndex = THEMES.indexOf(savedTheme);

            // Iniciar Seletores
            const now = new Date();
            const monthSelect = document.getElementById('month-select');
            MONTH_NAMES.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = m;
                if(i === now.getMonth()) opt.selected = true;
                monthSelect.appendChild(opt);
            });
            
            updateYearDisplay();
            
            const savedConfig = localStorage.getItem('heleninha_config_v5');
            if(savedConfig) {
                const data = JSON.parse(savedConfig);
                document.getElementById('day-select').value = data.day;
                currentYear = data.year || currentYear;
                updateYearDisplay();
            }

            generateDates();
            document.getElementById('loading-screen').style.display = 'none';
        };

        // --- FUN√á√ïES DE AUTH ---

        function setAuthMode(mode) {
            currentAuthMode = mode;
            const regFields = document.getElementById('register-only-fields');
            const submitBtn = document.getElementById('auth-submit-btn');
            const btnLogin = document.getElementById('btn-login-mode');
            const btnReg = document.getElementById('btn-register-mode');

            if (mode === 'login') {
                regFields.style.display = 'none';
                submitBtn.innerText = 'Entrar';
                btnLogin.classList.add('active');
                btnReg.classList.remove('active');
            } else {
                regFields.style.display = 'block';
                submitBtn.innerText = 'Cadastrar';
                btnLogin.classList.remove('active');
                btnReg.classList.add('active');
            }
        }

        async function handleAuthSubmit() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const info = document.getElementById('auth-info');
            
            if (!email || !password) {
                info.innerText = "Preencha todos os campos.";
                return;
            }

            document.getElementById('loading-screen').style.display = 'flex';

            if (currentAuthMode === 'login') {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    info.innerText = "Erro: " + error.message;
                    document.getElementById('loading-screen').style.display = 'none';
                } else {
                    location.reload();
                }
            } else {
                const confirm = document.getElementById('auth-confirm-password').value;
                if (password !== confirm) {
                    info.innerText = "As senhas n√£o coincidem.";
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }

                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    info.innerText = "Erro: " + error.message;
                } else {
                    info.innerText = "Conta criada! Verifique o seu e-mail para confirmar.";
                }
                document.getElementById('loading-screen').style.display = 'none';
            }
        }

        async function handleLogout() {
            if (confirm("Deseja encerrar a sess√£o?")) {
                await supabaseClient.auth.signOut();
                location.reload();
            }
        }

        function showAuth() {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-screen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
        }

        // --- L√ìGICA DO APP (PRESERVADA) ---

        function initSupabase(url, key) {
            try {
                supabaseClient = supabase.createClient(url, key);
                document.getElementById('supabase-status').innerText = "‚óè Sincroniza√ß√£o Ativa";
                document.getElementById('supabase-status').className = "supabase-status status-online";
            } catch (e) {
                console.error("Supabase Init Error", e);
                document.getElementById('supabase-status').innerText = "‚óè Erro de Liga√ß√£o";
                document.getElementById('supabase-status').className = "supabase-status status-offline";
            }
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function saveSettings() {
            prices[1] = parseFloat(document.getElementById('price-1').value) || 0;
            prices[2] = parseFloat(document.getElementById('price-2').value) || 0;
            prices[3] = parseFloat(document.getElementById('price-3').value) || 0;
            localStorage.setItem('heleninha_settings', JSON.stringify({ prices }));
            updateResult();
        }

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % THEMES.length;
            setTheme(THEMES[currentThemeIndex]);
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('heleninha_theme', theme);
            const icons = { 'light': '‚òÄÔ∏è', 'dark': 'üåô', 'violet': 'üîÆ' };
            document.getElementById('theme-icon').innerText = icons[theme];
        }

        function changeYear(delta) {
            currentYear += delta;
            updateYearDisplay();
            generateDates();
        }

        function updateYearDisplay() {
            document.getElementById('year-display').innerText = currentYear;
        }

        function generateDates() {
            const month = parseInt(document.getElementById('month-select').value);
            const targetDay = parseInt(document.getElementById('day-select').value);
            currentSessions = [];
            let date = new Date(currentYear, month, 1);
            while (date.getMonth() === month) {
                if (date.getDay() === targetDay) {
                    const d = String(date.getDate()).padStart(2, '0');
                    const m = String(date.getMonth() + 1).padStart(2, '0');
                    currentSessions.push({ date: `${d}/${m}`, students: 3 });
                }
                date.setDate(date.getDate() + 1);
            }
            renderSelectors();
            updateResult();
            localStorage.setItem('heleninha_config_v5', JSON.stringify({ day: targetDay, year: currentYear }));
        }

        function renderSelectors() {
            const container = document.getElementById('session-container');
            container.innerHTML = '';
            currentSessions.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = 'session-box';
                div.innerHTML = `
                    <span class="date-label">${s.date}</span>
                    <select class="session-select bg-${s.students}" onchange="updateAttendance(${i}, this.value)">
                        <option value="0" ${s.students === 0 ? 'selected' : ''}>0</option>
                        <option value="1" ${s.students === 1 ? 'selected' : ''}>1</option>
                        <option value="2" ${s.students === 2 ? 'selected' : ''}>2</option>
                        <option value="3" ${s.students === 3 ? 'selected' : ''}>3</option>
                    </select>
                `;
                container.appendChild(div);
            });
        }

        function updateAttendance(index, value) {
            currentSessions[index].students = parseInt(value);
            renderSelectors();
            updateResult();
        }

        function updateResult() {
            const monthIndex = document.getElementById('month-select').value;
            const monthName = MONTH_NAMES[monthIndex];
            let total = 0;
            let lines = `üóìÔ∏è *${monthName.toUpperCase()} / ${currentYear}*\n\n`;
            currentSessions.forEach(s => {
                if(s.students > 0) {
                    const price = prices[s.students];
                    total += price;
                    lines += `${s.date} - ${s.students} aluno(s) (R$ ${price})\n`;
                } else {
                    lines += `${s.date} - Sem aula / Falta\n`;
                }
            });
            currentTotal = total;
            lines += `\nüí∞ *TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*`;
            document.getElementById('result-text').innerText = lines;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3500);
        }

        async function saveToHistory() {
            const monthName = MONTH_NAMES[document.getElementById('month-select').value];
            const now = new Date();
            const timestampStr = `${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}`;
            const entry = { title: `${monthName.toUpperCase()} / ${currentYear}`, total: currentTotal, time: timestampStr, id: Date.now() };

            history.unshift(entry);
            if(history.length > 15) history.pop();
            localStorage.setItem('heleninha_history', JSON.stringify(history));
            renderHistory();

            if (supabaseClient) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                try {
                    const { error } = await supabaseClient
                        .from('trainer_history') 
                        .insert([{ 
                            title: entry.title, 
                            total: entry.total, 
                            timestamp: now.toISOString(),
                            details: document.getElementById('result-text').innerText
                        }]);
                    if (error) showToast(`Salvo local. Erro nuvem: ${error.message}`);
                    else showToast("‚úì Sincronizado na nuvem!");
                } catch (e) {
                    showToast("Erro cr√≠tico ao salvar na nuvem.");
                }
            } else {
                showToast("‚úì Salvo localmente!");
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if(history.length === 0) {
                list.innerHTML = '<p style="text-align:center; font-size:0.8rem; color:var(--text-muted); font-style:italic;">Nenhum registro salvo.</p>';
                return;
            }
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-header">
                        <span>${item.title}</span>
                        <span class="history-total">R$ ${item.total.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div class="history-date">Salvo em ${item.time}</div>
                `;
                list.appendChild(div);
            });
        }

        function clearHistory() {
            if(confirm("Deseja apagar todo o hist√≥rico local?")) {
                history = [];
                localStorage.removeItem('heleninha_history');
                renderHistory();
                showToast("Hist√≥rico limpo");
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('result-text').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                showToast("‚úì Copiado para o WhatsApp!");
            } catch (err) {
                console.error('Erro ao copiar texto');
            }
            document.body.removeChild(el);
        }
    </script>
</body>
</html>

