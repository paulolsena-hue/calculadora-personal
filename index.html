<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heleninha Trainer - Performance e Sa√∫de</title>
    <!-- Font Fredoka para t√≠tulos amig√°veis e robustos -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configura√ß√µes para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Heleninha PT">
    
    <style>
        /* Vari√°veis de Tema Conforme Protocolo UI */
        :root {
            --bg-body: #F0F4FF; /* Azul Gelo Clar√≠ssimo */
            --bg-card: #FFFFFF; /* Branco */
            --text-main: #1D2D6B; /* Azul Marinho contraste */
            --text-muted: #5C6B9A;
            --primary: #3D79FF; /* Azul M√©dio */
            --primary-hover: #2C5ED6;
            --accent: #FF8FB1; /* Rosa Suave (Cora√ß√£o/Destaque) */
            --navy: #1D2D6B; /* Azul Marinho Profundo */
            --border-color: #DDE5F5;
            --result-bg: #0A0F1E;
            --result-text: #3D79FF;
            --radius-card: 24px;
            --radius-input: 16px;
        }

        [data-theme='dark'] {
            --bg-body: #0A0F1E;
            --bg-card: #161C2D;
            --text-main: #F0F4FF;
            --text-muted: #8E9ABF;
            --border-color: #242D45;
            --result-bg: #000000;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-in-out; -webkit-tap-highlight-color: transparent; }
        html { font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); line-height: 1.5; }
        .container { max-width: 500px; margin: 0 auto; }

        /* Cabe√ßalho e Logotipo Redesenhado: Cron√¥metro + Cora√ß√£o */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 44px; height: 44px; }
        h1 { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; margin: 0; font-weight: 700; letter-spacing: -0.01em; text-transform: uppercase; color: var(--navy); }

        /* Bot√µes de A√ß√£o UI */
        .header-actions { display: flex; gap: 10px; }
        .action-btn { 
            border: none; 
            background: var(--primary); 
            color: white;
            width: 42px; height: 42px; 
            border-radius: 14px; 
            cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; 
            box-shadow: 0 4px 10px rgba(61, 121, 255, 0.2);
        }
        .action-btn:active { transform: scale(0.9); background-color: var(--accent); }

        /* Auth UI */
        #auth-screen { display: flex; flex-direction: column; justify-content: center; min-height: 80vh; }
        .auth-card { background: var(--bg-card); padding: 30px; border-radius: var(--radius-card); border: 1px solid var(--border-color); box-shadow: 0 15px 30px rgba(29, 45, 107, 0.05); }
        .auth-toggle { display: flex; gap: 10px; margin-bottom: 25px; background: var(--bg-body); padding: 5px; border-radius: 12px; }
        .auth-toggle button { flex: 1; border: none; padding: 10px; border-radius: 10px; font-family: 'Fredoka', sans-serif; font-weight: 600; cursor: pointer; background: transparent; color: var(--text-muted); }
        .auth-toggle button.active { background: var(--primary); color: white; }
        .auth-footer { text-align: center; margin-top: 15px; font-size: 0.8rem; color: var(--text-muted); }

        /* App Visibility */
        #app-screen { display: none; }

        .card { 
            background: var(--bg-card); 
            padding: 24px; 
            border-radius: var(--radius-card); 
            box-shadow: 0 15px 30px -5px rgba(29, 45, 107, 0.05); 
            border: 1px solid var(--border-color); 
            margin-bottom: 25px; 
        }

        .label { 
            display: block; 
            font-family: 'Fredoka', sans-serif;
            font-size: 0.8rem; 
            font-weight: 600; 
            margin-bottom: 10px; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 0.08em; 
        }
        
        select, .input-styled { 
            width: 100%; padding: 14px; 
            border-radius: var(--radius-input); 
            border: 2px solid var(--border-color); 
            margin-bottom: 20px; 
            font-size: 1rem; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            outline: none; 
            font-weight: 600;
        }

        .year-stepper { 
            display: flex; align-items: center; justify-content: space-between; 
            background: var(--bg-body); 
            border-radius: var(--radius-input); 
            padding: 8px; margin-bottom: 20px; 
            border: 2px solid var(--border-color); 
        }
        .step-btn { 
            background: var(--primary); color: white; 
            border: none; width: 44px; height: 44px; 
            border-radius: 12px; font-size: 1.5rem; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .year-display { font-family: 'Fredoka', sans-serif; font-size: 1.3rem; font-weight: 700; color: var(--navy); }

        .session-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(65px, 1fr)); gap: 15px; margin-bottom: 10px; }
        .session-box { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .date-label { font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; display: block; color: var(--text-muted); }
        
        .session-select {
            -webkit-appearance: none; appearance: none;
            width: 58px; height: 58px; border-radius: 50%; border: none;
            color: white; font-weight: 900; font-size: 1.4rem;
            text-align: center; text-align-last: center; 
            cursor: pointer; padding: 0;
            background-color: var(--primary); 
            box-shadow: 0 6px 12px rgba(61, 121, 255, 0.15);
            display: flex; align-items: center; justify-content: center;
            outline: none;
        }
        
        .bg-0 { background-color: #B0B9D1; opacity: 0.6; }
        .bg-1 { background-color: var(--primary); }
        .bg-2 { background-color: #2C5ED6; }
        .bg-3 { background-color: var(--navy); }

        .result-box { 
            background: var(--result-bg); color: #8E9ABF; 
            padding: 20px; border-radius: 20px; 
            font-family: 'Courier New', monospace; font-size: 0.95rem; 
            white-space: pre-wrap; margin-bottom: 10px; 
            min-height: 100px; border: 2px solid var(--primary); line-height: 1.5; 
        }
        
        .button-group { display: flex; gap: 10px; margin-bottom: 25px; }

        .copy-btn { 
            flex: 2;
            background-color: var(--navy); 
            color: white; 
            padding: 18px; 
            border: none; 
            border-radius: 18px; 
            font-family: 'Fredoka', sans-serif;
            font-weight: 600; font-size: 1rem; 
            cursor: pointer; 
            box-shadow: 0 8px 20px rgba(29, 45, 107, 0.2); 
            text-transform: uppercase;
        }

        .save-btn {
            flex: 1;
            background-color: var(--accent);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 18px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600; font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 143, 177, 0.2);
        }

        .copy-btn:active, .save-btn:active { transform: translateY(3px); box-shadow: none; }

        /* Hist√≥rico */
        .history-section { margin-top: 30px; }
        .history-title { font-family: 'Fredoka', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: var(--navy); display: flex; justify-content: space-between; align-items: center; }
        .clear-history { font-size: 0.7rem; color: var(--accent); cursor: pointer; text-transform: uppercase; border: 1px solid var(--accent); padding: 4px 8px; border-radius: 8px; }
        
        .history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { 
            background: var(--bg-card); 
            padding: 16px; 
            border-radius: 18px; 
            border-left: 6px solid var(--primary); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .history-header { display: flex; justify-content: space-between; font-weight: 700; font-size: 0.9rem; margin-bottom: 5px; }
        .history-date { font-size: 0.7rem; color: var(--text-muted); }
        .history-total { color: var(--primary); font-family: 'Fredoka', sans-serif; font-weight: 700; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 30, 0.6); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 32px; padding: 30px; border: 1px solid var(--border-color); overflow-y: auto; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .modal-title { font-family: 'Fredoka', sans-serif; font-weight: 700; font-size: 1.3rem; color: var(--navy); }
        .close-modal { font-size: 2rem; cursor: pointer; background: none; border: none; color: var(--accent); font-weight: bold; }
        
        .price-input-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .price-input-row span { flex: 1.5; font-weight: 700; font-size: 0.9rem; color: var(--text-muted); }
        .price-input-row input { flex: 1; margin-bottom: 0; text-align: right; font-weight: 800; border-color: var(--border-color); color: var(--primary); }

        .supabase-status { font-size: 0.7rem; margin-top: 10px; display: block; text-align: center; font-weight: 600; }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }

        .toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; padding: 14px 28px; border-radius: 40px; font-family: 'Fredoka', sans-serif; font-size: 0.9rem; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 300; box-shadow: 0 8px 15px rgba(255, 143, 177, 0.3); }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Overlay de Carregamento -->
    <div id="loading-screen" class="loading-overlay">
        <div class="spinner"></div>
        <p style="font-family:'Fredoka', sans-serif; color:var(--navy)">Heleninha Trainer</p>
    </div>

    <!-- Tela de Auth -->
    <div id="auth-screen" class="container" style="display: none;">
        <div class="logo-area" style="justify-content: center; margin-bottom: 20px;">
            <!-- Logotipo Redesenhado: Cron√¥metro com Cora√ß√£o em Rosa -->
            <svg class="logo-icon" viewBox="0 0 24 24">
                <!-- Stopwatch Frame -->
                <path d="M12,20A7,7 0 0,1 5,13A7,7 0 0,1 12,6A7,7 0 0,1 19,13A7,7 0 0,1 12,20M12,4A9,9 0 0,0 3,13A9,9 0 0,0 12,22A9,9 0 0,0 21,13A9,9 0 0,0 12,4M7.88,3.39L6.6,1.86L2.02,5.71L3.3,7.24L7.88,3.39M21.98,5.71L17.4,1.86L16.12,3.39L20.7,7.24L21.98,5.71Z" fill="var(--primary)"/>
                <!-- Heart shape -->
                <path d="M12,15.64L11.1,14.82C7.92,11.94 5.82,10.05 5.82,7.73C5.82,5.84 7.3,4.36 9.18,4.36C10.24,4.36 11.27,4.86 11.91,5.64C12.55,4.86 13.57,4.36 14.64,4.36C16.52,4.36 18,5.84 18,7.73C18,10.05 15.9,11.94 12.71,14.83L11.82,15.64Z" fill="var(--accent)"/>
            </svg>
            <h1>HELENINHA</h1>
        </div>
        <div class="auth-card">
            <div class="auth-toggle">
                <button id="btn-login-mode" class="active" onclick="setAuthMode('login')">Login</button>
                <button id="btn-register-mode" onclick="setAuthMode('register')">Registo</button>
            </div>
            <span class="label">E-mail</span>
            <input type="email" id="auth-email" class="input-styled" placeholder="seu@email.com">
            <span class="label">Senha</span>
            <input type="password" id="auth-password" class="input-styled" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div id="register-only-fields" style="display: none;">
                <span class="label">Confirmar Senha</span>
                <input type="password" id="auth-confirm-password" class="input-styled" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button id="auth-submit-btn" class="copy-btn" style="width: 100%;" onclick="handleAuthSubmit()">Entrar</button>
            <p id="auth-info" class="auth-footer"></p>
        </div>
    </div>

    <!-- Tela do App -->
    <div id="app-screen" class="container">
        <header>
            <div class="logo-area">
                <!-- Logotipo Redesenhado -->
                <svg class="logo-icon" viewBox="0 0 24 24">
                    <path d="M12,20A7,7 0 0,1 5,13A7,7 0 0,1 12,6A7,7 0 0,1 19,13A7,7 0 0,1 12,20M12,4A9,9 0 0,0 3,13A9,9 0 0,0 12,22A9,9 0 0,0 21,13A9,9 0 0,0 12,4M7.88,3.39L6.6,1.86L2.02,5.71L3.3,7.24L7.88,3.39M21.98,5.71L17.4,1.86L16.12,3.39L20.7,7.24L21.98,5.71Z" fill="var(--primary)"/>
                    <path d="M12,15.64L11.1,14.82C7.92,11.94 5.82,10.05 5.82,7.73C5.82,5.84 7.3,4.36 9.18,4.36C10.24,4.36 11.27,4.86 11.91,5.64C12.55,4.86 13.57,4.36 14.64,4.36C16.52,4.36 18,5.84 18,7.73C18,10.05 15.9,11.94 12.71,14.83L11.82,15.64Z" fill="var(--accent)"/>
                </svg>
                <h1>HELENINHA</h1>
            </div>
            <div class="header-actions">
                <button class="action-btn" onclick="toggleSettings()" title="Ajustar">‚öôÔ∏è</button>
                <button class="action-btn" onclick="cycleTheme()" id="theme-icon">‚òÄÔ∏è</button>
                <button class="action-btn" onclick="handleLogout()" style="background-color: var(--accent);">üö™</button>
            </div>
        </header>

        <div class="card">
            <span class="label">M√™s de Cobran√ßa</span>
            <select id="month-select" onchange="handleDateConfigChange()"></select>

            <span class="label">Ano</span>
            <div class="year-stepper">
                <button class="step-btn" onclick="changeYear(-1)">‚àí</button>
                <span id="year-display" class="year-display">2026</span>
                <button class="step-btn" onclick="changeYear(1)">+</button>
            </div>

            <span class="label">Dia da Aula Semanal</span>
            <select id="day-select" onchange="handleDateConfigChange()">
                <option value="1">Segunda-feira</option>
                <option value="2">Ter√ßa-feira</option>
                <option value="3">Quarta-feira</option>
                <option value="4">Quinta-feira</option>
                <option value="5">Sexta-feira</option>
                <option value="6">S√°bado</option>
                <option value="0">Domingo</option>
            </select>

            <span class="label">Participantes</span>
            <div id="session-container" class="session-grid"></div>
        </div>

        <div class="label">Resumo WhatsApp:</div>
        <div id="result-text" class="result-box"></div>
        
        <div class="button-group">
            <button class="copy-btn" onclick="copyToClipboard()">Copiar WhatsApp</button>
            <button class="save-btn" onclick="saveToHistory()" title="Gravar Hist√≥rico">üíæ</button>
        </div>

        <div class="history-section">
            <div class="history-title">
                <span>Hist√≥rico na Nuvem</span>
                <span class="clear-history" onclick="clearHistory()">Limpar</span>
            </div>
            <div id="history-list" class="history-list"></div>
        </div>

        <div id="toast" class="toast">‚úì Conclu√≠do!</div>
    </div>

    <!-- Modal Settings -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Configurar Pacotes</span>
                <button class="close-modal" onclick="toggleSettings()">√ó</button>
            </div>
            <div class="price-input-row"><span>Solo:</span><input type="number" id="price-1" class="input-styled" onchange="saveSettings()"></div>
            <div class="price-input-row"><span>Duo:</span><input type="number" id="price-2" class="input-styled" onchange="saveSettings()"></div>
            <div class="price-input-row"><span>Trio:</span><input type="number" id="price-3" class="input-styled" onchange="saveSettings()"></div>
            <hr style="border:0; border-top:1px solid var(--border-color); margin:20px 0;">
            <span id="supabase-status" class="supabase-status status-offline">‚óè Desconectado</span>
            <button class="copy-btn" style="width:100%" onclick="toggleSettings()">FECHAR</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://xmbydwfxkbpcjmojtyvk.supabase.co";
        const SUPABASE_KEY = "sb_publishable_9cmC_iJS5VL6j_W_CetgXw_k-pf5gii";
        const MONTH_NAMES = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const THEMES = ['light', 'dark'];

        let prices = { 1: 75, 2: 95, 3: 115 };
        let currentSessions = [];
        let currentYear = new Date().getFullYear();
        let currentUser = null;
        let supabaseClient = null;

        window.onload = async () => {
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showApp();
                await syncFromCloud();
                await renderHistory();
            } else {
                showAuth();
            }

            setTheme(localStorage.getItem('heleninha_theme') || 'light');
            initSelectors();
            document.getElementById('loading-screen').style.display = 'none';
        };

        function initSelectors() {
            const ms = document.getElementById('month-select');
            MONTH_NAMES.forEach((m, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.text = m;
                if(i === new Date().getMonth()) opt.selected = true;
                ms.appendChild(opt);
            });
            updateYearDisplay();
            generateDates();
        }

        // --- AUTH ---
        function setAuthMode(mode) {
            document.getElementById('register-only-fields').style.display = mode === 'login' ? 'none' : 'block';
            document.getElementById('auth-submit-btn').innerText = mode === 'login' ? 'Entrar' : 'Cadastrar';
            document.getElementById('btn-login-mode').className = mode === 'login' ? 'active' : '';
            document.getElementById('btn-register-mode').className = mode === 'register' ? 'active' : '';
        }

        async function handleAuthSubmit() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || !password) return;
            document.getElementById('loading-screen').style.display = 'flex';

            const isReg = document.getElementById('btn-register-mode').classList.contains('active');
            const { error } = isReg 
                ? await supabaseClient.auth.signUp({ email, password }) 
                : await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                document.getElementById('auth-info').innerText = error.message;
                document.getElementById('loading-screen').style.display = 'none';
            } else {
                if(isReg) document.getElementById('auth-info').innerText = "Verifique o seu e-mail para ativar a conta!";
                else location.reload();
            }
        }

        async function handleLogout() { if(confirm("Sair?")) { await supabaseClient.auth.signOut(); location.reload(); } }
        function showAuth() { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-screen').style.display = 'none'; }
        function showApp() { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-screen').style.display = 'block'; }

        // --- CLOUD SYNC ---
        async function syncToCloud() {
            if (!currentUser) return;
            const state = { prices, currentYear, day: document.getElementById('day-select').value, month: document.getElementById('month-select').value, sessions: currentSessions.map(s => s.students) };
            await supabaseClient.from('trainer_state').upsert({ user_id: currentUser.id, data_json: state, updated_at: new Date().toISOString() });
        }

        async function syncFromCloud() {
            const { data } = await supabaseClient.from('trainer_state').select('data_json').eq('user_id', currentUser.id).single();
            if (data?.data_json) {
                const s = data.data_json;
                prices = s.prices || prices;
                currentYear = s.currentYear || currentYear;
                document.getElementById('month-select').value = s.month;
                document.getElementById('day-select').value = s.day;
                updateYearDisplay();
                generateDates();
                if(s.sessions) currentSessions.forEach((sess, i) => sess.students = s.sessions[i] || 0);
                document.getElementById('price-1').value = prices[1];
                document.getElementById('price-2').value = prices[2];
                document.getElementById('price-3').value = prices[3];
                renderSelectors(); updateResult();
            }
        }

        // --- CORE LOGIC ---
        function changeYear(n) { currentYear += n; updateYearDisplay(); generateDates(); syncToCloud(); }
        function updateYearDisplay() { document.getElementById('year-display').innerText = currentYear; }
        function handleDateConfigChange() { generateDates(); syncToCloud(); }

        function generateDates() {
            const m = parseInt(document.getElementById('month-select').value);
            const dW = parseInt(document.getElementById('day-select').value);
            currentSessions = [];
            let d = new Date(currentYear, m, 1);
            while (d.getMonth() === m) {
                if (d.getDay() === dW) {
                    currentSessions.push({ date: `${String(d.getDate()).padStart(2, '0')}/${String(m+1).padStart(2, '0')}`, students: 3 });
                }
                d.setDate(d.getDate() + 1);
            }
            renderSelectors(); updateResult();
        }

        function renderSelectors() {
            const c = document.getElementById('session-container'); c.innerHTML = '';
            currentSessions.forEach((s, i) => {
                const div = document.createElement('div'); div.className = 'session-box';
                div.innerHTML = `<span class="date-label">${s.date}</span>
                    <select class="session-select bg-${s.students}" onchange="updateAttendance(${i}, this.value)">
                        <option value="0" ${s.students==0?'selected':''}>0</option>
                        <option value="1" ${s.students==1?'selected':''}>1</option>
                        <option value="2" ${s.students==2?'selected':''}>2</option>
                        <option value="3" ${s.students==3?'selected':''}>3</option>
                    </select>`;
                c.appendChild(div);
            });
        }

        function updateAttendance(i, v) { currentSessions[i].students = parseInt(v); renderSelectors(); updateResult(); syncToCloud(); }

        function updateResult() {
            const mN = MONTH_NAMES[document.getElementById('month-select').value];
            let total = 0;
            let lines = `üóìÔ∏è *${mN.toUpperCase()} / ${currentYear}*\n\n`;
            currentSessions.forEach(s => {
                const p = prices[s.students] || 0;
                total += p;
                lines += s.students > 0 ? `${s.date} - ${s.students} aluno(s) (R$ ${p})\n` : `${s.date} - Sem aula / Falta\n`;
            });
            lines += `\nüí∞ *TOTAL: R$ ${total.toFixed(2).replace('.', ',')}*`;
            document.getElementById('result-text').innerText = lines;
            return { total, lines, title: `${mN.toUpperCase()} / ${currentYear}` };
        }

        async function saveToHistory() {
            const res = updateResult();
            const { error } = await supabaseClient.from('trainer_history').insert([{ user_id: currentUser.id, title: res.title, total: res.total, timestamp: new Date().toISOString(), details: res.lines }]);
            if (error) showToast("Erro!"); else { showToast("‚úì Gravado!"); renderHistory(); }
        }

        async function renderHistory() {
            const { data } = await supabaseClient.from('trainer_history').select('*').eq('user_id', currentUser.id).order('timestamp', { ascending: false }).limit(10);
            const l = document.getElementById('history-list'); l.innerHTML = data?.length ? '' : '<p style="text-align:center;font-size:0.8rem;color:var(--text-muted)">Sem hist√≥rico.</p>';
            data?.forEach(item => {
                const d = new Date(item.timestamp);
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div class="history-header"><span>${item.title}</span><span class="history-total">R$ ${item.total.toFixed(2).replace('.',',')}</span></div>
                                 <div class="history-date">Salvo em ${d.toLocaleDateString()} √†s ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
                l.appendChild(div);
            });
        }

        async function clearHistory() { if(confirm("Apagar hist√≥rico da nuvem?")) { await supabaseClient.from('trainer_history').delete().eq('user_id', currentUser.id); renderHistory(); } }

        // --- UI UTILS ---
        function toggleSettings() { const m = document.getElementById('settings-modal'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }
        function saveSettings() { prices[1] = parseInt(document.getElementById('price-1').value); prices[2] = parseInt(document.getElementById('price-2').value); prices[3] = parseInt(document.getElementById('price-3').value); updateResult(); syncToCloud(); }
        function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('heleninha_theme', t); document.getElementById('theme-icon').innerText = t === 'light' ? '‚òÄÔ∏è' : 'üåô'; }
        function cycleTheme() { setTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3500); }
        function copyToClipboard() { const text = document.getElementById('result-text').innerText; const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("‚úì Copiado!"); }
    </script>
</body>
</html>
